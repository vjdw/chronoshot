<html>
  <head>
    <script type="text/javascript" src="./vlist.js"></script>
    <style>
      body {
        margin: 0px;
        padding: 0px;
        border: 0px;
        overflow: hidden;
        background: gainsboro;
      }

      #divMain {
        display: flex;
      }

      #divMain > div {
        display: inline;
      }

      .divGridItem
      {
        display: inline;
        position: relative;
        margin: 20px; /* also used in totalColumnCount calculation */
      }

      .divGridRowLeftSpacer
      {
        display: inline;
      }

      .divGridRow
      {
        margin: 20px 0px;
      }

      .imgThumbnail
      {
        border-radius: 10%;
      }

      .pExifDateTime {
        position:absolute;
        bottom:-10px;
        left: 0px;
        width:100%;
        background:rgba(251,251,251,0.5);
        text-align:center;
        color: gainsboro;
        font: bold 12px/18px Helvetica, Sans-Serif;
        background: rgba(0, 0, 0, 0.7);
        border-bottom-left-radius: 20px;
        border-bottom-right-radius: 20px;
      }

      /* The Modal (background) */
      .modal {
          display: none; /* Hidden by default */
          position: fixed; /* Stay in place */
          z-index: 1; /* Sit on top */
          /*padding-top: 100px;  Location of the box */
          left: 0;
          top: 0;
          width: 100%; /* Full width */
          height: 100%; /* Full height */
          overflow: auto; /* Enable scroll if needed */
          background-color: rgb(0,0,0); /* Fallback color */
          background-color: rgba(0,0,0,0.9); /* Black w/ opacity */
      }

      /* Modal Content (image) */
      .modal-content {
          margin: auto;
          display: block;
          width: auto;
          height: 100%;
          /*max-width: 700px;*/
      }

      /* Caption of Modal Image */
      #caption {
          margin: auto;
          display: block;
          width: 80%;
          max-width: 700px;
          text-align: center;
          color: #ccc;
          padding: 10px 0;
          height: 150px;
      }

      /* Add Animation */
      /*.modal-content, #caption {
          -webkit-animation-name: zoom;
          -webkit-animation-duration: 0.6s;
          animation-name: zoom;
          animation-duration: 0.6s;
      }

      @-webkit-keyframes zoom {
          from {-webkit-transform:scale(0)}
          to {-webkit-transform:scale(1)}
      }

      @keyframes zoom {
          from {transform:scale(0)}
          to {transform:scale(1)}
      }*/

      /* The Close Button */
      .close {
          position: absolute;
          z-index: 2;
          top: 15px;
          right: 35px;
          color: #f1f1f1;
          font-size: 40px;
          font-weight: bold;
          transition: 0.3s;
      }

      .close:hover,
      .close:focus {
          color: #bbb;
          text-decoration: none;
          cursor: pointer;
      }

      /* The Select Button */
      .select {
          position: absolute;
          z-index: 2;
          top: 15px;
          left: 35px;
          color: #f1f1f1;
          font-size: 40px;
          font-weight: bold;
          transition: 0.3s;
      }

      .select:hover,
      .select:focus {
          color: #bbb;
          text-decoration: none;
          cursor: pointer;
      }

      /* The Download Button */
      .download {
          position: absolute;
          z-index: 2;
          bottom: 15px;
          right: 35px;

          transition: 0.3s;
          /*background:rgba(251,251,251,0.5);*/
          text-align:center;
          font: bold 18px Helvetica, Sans-Serif;
          background: rgba(0, 0, 0, 0.7);
          border-radius: 5px;
          color: #555
      }

      .download a:link, .download a:visited {color: #983000;}
      .download a:hover, .download a:active { color: #fe5000;}

      /* 100% Image Width on Smaller Screens */
      @media only screen and (max-width: 700px){
          .modal-content {
              width: 100%;
          }
      }

      .contentContainer {
          position:relative;
          margin: auto;
          display: block;
          width: auto;
      }
      .contentPrevious {
          float: left;
          position: absolute;
          left: 0px;
          top: 0px;
          height: 100%;
          min-width: 50%;
      }
      .contentNext {
          float: right;
          position: absolute;
          right: 0px;
          top: 0px;
          height: 100%;
          min-width: 50%;
      }

    </style>
  </head>

  <body>
    <div id="divModal" class="modal">
      <span class="close">&times;</span>
      <span id="spanSelect" class="select">☆</span>
      <div class="contentContainer">
        <div class="contentPrevious" onclick="moveModal(false)"></div>
        <img class="modal-content" id="imgModal1">
        <img class="modal-content" id="imgModal2">
        <img class="modal-content" id="imgModal3">
        <div class="contentNext" onclick="moveModal(true)"></div>
      </div>
      <div id="divDownload" class="download">download</div>
    </div>

    <div id="divScrollPosition">
      <span id="spanDateTime"></span>
    </div>

    <div id="divMain">
      <!--<div id="divGrid"/>-->
    </div>

    <script>
      var totalAssetCount = 0;
      var divGridItemPadding = 20; // Must match CSS .divGridItem padding
      var thumbnailSize = 200;
      var thumbnailOuterSize = thumbnailSize + (2 * divGridItemPadding);
      var totalColumnCount = Math.floor((window.innerWidth - (2 * divGridItemPadding)) / thumbnailOuterSize);
      var leftPaddingToCentraliseGrid = (window.innerWidth - (totalColumnCount * thumbnailOuterSize) - (2 * divGridItemPadding)) / 2;
      var totalRowCount = 0;
      var assetKeys = [];
      var setName = 'all';

      // The thumbnail most recently loaded from server,
      // only for an estimate of currently visible datetime.
      var visibleImgKey = ""

      var modal = {
        assetIndex: -1,
        assetIsSelected: false, // a.k.a. "starred"
        divModal: document.getElementById('divModal'),
        imgPrevious: document.getElementById("imgModal1"),
        imgCurrent: document.getElementById("imgModal2"),
        imgNext: document.getElementById("imgModal3"),
      };

      function initialise(setName) {
        fetch('/getAssetKeys/?set='+setName).then(function (response) {
          response.json().then(function(allAssets) {
            assetKeys = allAssets;
            totalAssetCount = assetKeys.length;
            totalRowCount = totalAssetCount / totalColumnCount; 

            configureVirtualList();
            initialiseModalButtons();
            updateDateTimeBanner();
          });
        });
      }

      function moveModal(moveForwards) {
        // There are 3 img elements, Previous, Current and Next.
        // Current is always the image on display.
        // Previous and Next are used to preload the photos in each direction.

        var oldCurrent = modal.imgCurrent;
        modal.imgCurrent = moveForwards ? modal.imgNext : modal.imgPrevious;
        if (moveForwards) {
          modal.imgNext = oldCurrent;
          modal.imgNext.style.display = "none";
        }
        else {
          modal.imgPrevious = oldCurrent;
          modal.imgPrevious.style.display = "none";
        }
        modal.imgCurrent.style.display = "block";

        modal.assetIndex = modal.assetIndex + (moveForwards ? 1 : -1);

        modal.imgNext.src = "/getAsset/?id=" + assetKeys[modal.assetIndex+1];
        modal.imgPrevious.src = "/getAsset/?id=" + assetKeys[modal.assetIndex-1];

        updateModalDetails(modal.assetIndex);
      }

      var previousOnScroll = Date.now();
      function onScroll(e) {
        var now = Date.now();
        if (now - previousOnScroll > 250) {
          updateDateTimeBanner();
          previousOnScroll = now;
        }
      }

      function updateDateTimeBanner() {
        fetch('/getExifDateTime/?id='+visibleImgKey).then(function (response) {
          response.json().then(function(result) {
            var spanDateTime = document.getElementById('spanDateTime');
            spanDateTime.innerText = result.datetime;
          });
        });
      }

      function updateModalDetails(assetIndex) {
        var assetKey = assetKeys[assetIndex];

        (function (assetKey) {
                fetch('/getExifDateTime/?id='+assetKey).then(function (response) {
                  response.json().then(function(result) {
                    var divDownload = document.getElementById('divDownload');
                    var aDownload = document.createElement("a");
                    aDownload.href = "/getAsset/?id=" + assetKey;
                    aDownload.download = result.datetime;
                    aDownload.innerText = result.datetime;
                    divDownload.innerHTML = "";
                    divDownload.appendChild(aDownload);
                  });
                });
              })(assetKey);

        (function (assetKey) {
                fetch('/select/?id='+assetKey).then(function (response) {
                  response.json().then(function(result) {
                    modal.assetIsSelected = result.isSelected;
                    var spanSelected = document.getElementById('spanSelect')
                    spanSelected.innerText = modal.assetIsSelected ? "★" : "☆";
                  });
                });
              })(assetKey);
      }

      function configureVirtualList() {
        var list = new VirtualList({
          w: window.innerWidth,
          h: window.innerHeight,
          itemHeight: 240,
          totalRows: totalRowCount,
          generatorFn: function(row) {
            visibleImgKey = assetKeys[row*totalColumnCount];
            var divGridRow = document.createElement("div");
            divGridRow.className = "divGridRow"

            var divGridRowLeftSpacer = document.createElement("div");
            divGridRowLeftSpacer.className = "divGridRowLeftSpacer";
            divGridRowLeftSpacer.style.paddingLeft = leftPaddingToCentraliseGrid + "px";
            divGridRow.appendChild(divGridRowLeftSpacer);

            for (var column = 0; column < totalColumnCount; column++) {
              var divGridItem = document.createElement("div");
              divGridItem.className = "divGridItem";
              divGridRow.appendChild(divGridItem);

              var assetIndex = ((row * totalColumnCount) + column);
              var assetKey = assetKeys[assetIndex];

              // The image thumbnail.
              var imgThumbnail = document.createElement("img");
              imgThumbnail.src = "/getThumbnail/?id=" + assetKey;
              imgThumbnail.className = "imgThumbnail"
              imgThumbnail.width = thumbnailSize;
              imgThumbnail.height = thumbnailSize;
              imgThumbnail.onclick = function(assetIndex) {
                return function() {
                  modal.assetIndex = assetIndex;
                  var assetKey = assetKeys[assetIndex];
                  modal.divModal.style.display = "block";
                  modal.imgCurrent.src = "/getAsset/?id=" + assetKey;
                  // Try to cache the next images
                  if (assetIndex < (totalAssetCount-1)) {
                    modal.imgNext.src = "/getAsset/?id=" + assetKeys[assetIndex+1];
                  }
                  if (assetIndex > 0) {
                    modal.imgPrevious.src = "/getAsset/?id=" + assetKeys[assetIndex-1];
                  }

                  updateModalDetails(assetIndex);
                };
              }(assetIndex);
              divGridItem.appendChild(imgThumbnail);

              // The exif datetime element.
              var pExifDateTime = document.createElement("p");
              pExifDateTime.className = "pExifDateTime";
              pExifDateTime.innerText = "...";
              divGridItem.appendChild(pExifDateTime);
              (function (pExifDateTime, assetKey, divGridRow) {
                // Avoid calling getExifDateTime for every row that whizzes by.
                //await sleep(750);
                //if (document.body.contains(divGridRow)) {
                  fetch('/getExifDateTime/?id='+assetKey).then(function (response) {
                    response.json().then(function(result) {
                      pExifDateTime.innerText = result.datetime;
                    });
                  });
                //}
              })(pExifDateTime, assetKey, divGridRow);
            }
            return divGridRow;
          }
        });
        var divMain = document.getElementById('divMain');
        divMain.appendChild(list.container);
        list.container.addEventListener('scroll', onScroll);
      }

      function initialiseModalButtons() {
        // Get the <span> element that closes the modal
        modal.imgPrevious.style.display = "none";
        modal.imgNext.style.display = "none";
        var span = document.getElementsByClassName("close")[0];
        span.onclick = function() {
          modal.divModal.style.display = "none";
        }

        // Get the <span> element that selects a photo
        var span = document.getElementsByClassName("select")[0];
        span.onclick = function() {
          modal.assetIsSelected = !modal.assetIsSelected;
          var assetKey = assetKeys[modal.assetIndex];

          fetch("/select/", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({assetKey: assetKey, isSelected: modal.assetIsSelected})
          });
          updateModalDetails(modal.assetIndex);
        }
      }

      // xyzzy move to helpers.js?
      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      // xyzzy move to helpers.js?
      function getParameterByName(name, url) {
        if (!url)
          url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
        if (!results)
          return null;
        if (!results[2])
          return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }

      setName = getParameterByName('set');
      if (setName === '')
        setName = 'all';
      initialise(setName);

    </script>
  <body>
<html>